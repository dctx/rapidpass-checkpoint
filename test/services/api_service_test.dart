import 'package:csv/csv.dart';
import 'package:moor_ffi/moor_ffi.dart';
import 'package:rapidpass_checkpoint/data/app_database.dart';
import 'package:rapidpass_checkpoint/services/api_service.dart';
import 'package:test/test.dart';
import 'package:vcr/vcr.dart';

void main() {
  ApiService apiService;

  AppDatabase database;

  setUp(() {
    database = AppDatabase(VmDatabase.memory());
  });
  tearDown(() async {
    // noop
  });

  group('ApiService test group', () {
    test('test getBatchPasses', () async {
      final VcrAdapter adapter = VcrAdapter();
      adapter.useCassette('batch/access-passes');
      apiService = ApiService(
          httpClientAdapter: adapter,
          baseUrl: 'https://rapidpass-api.azurewebsites.net/api/v1/');
      final int before = await database.countPasses();
      print('before: $before');
      try {
        final companions = await apiService.getBatchPasses();
        companions.forEach((companion) async {
          await database.insertValidPass(companion);
        });
      } catch (e) {
        print(e);
      }
      final int after = await database.countPasses();
      print('after: $after');
      expect(after, equals(before + 39));
    });
    test('csv decode', () {
      final rawCsv =
          '\"APORTYPE\",\"CONTROLCODE\",\"IDENTIFIERNUMBER\",\"IDTYPE\",\"ISSUEDON\",\"PASSTYPE\",\"STATUS\",\"VALIDFROM\",\"VALIDUNTIL\"\n\"AG\",\"\",\"Darren\",\"LTO\",\"1585840127\",\"INDIVIDUAL\",\"APPROVED\",\"1585840127\",\"1587136127\"\n\"AG\",\"\",\"Jonathan\",\"LTO\",\"1585840238\",\"INDIVIDUAL\",\"APPROVED\",\"1585840238\",\"1587136238\"\n\"ME\",\"0Y5YW40Y\",\"12345abcd\",\"OFW\",\"1585842318\",\"INDIVIDUAL\",\"APPROVED\",\"1585842355\",\"1586707199\"\n\"BA\",\"1FQ99RGG\",\"4567\",\"NBI\",\"1585847729\",\"INDIVIDUAL\",\"APPROVED\",\"1585847739\",\"1586707199\"\n\"DO\",\"000000VK\",\"12\",\"LTO\",\"1585848392\",\"INDIVIDUAL\",\"APPROVED\",\"1585848469\",\"1586707199\"\n\"BP\",\"000000VK\",\"N02-12345670\",\"PLT\",\"1585850020\",\"VEHICLE\",\"APPROVED\",\"1585850064\",\"1586707199\"\n\"GR\",\"000000VK\",\"ID907774623\",\"SNR\",\"1585853258\",\"INDIVIDUAL\",\"APPROVED\",\"1585879297\",\"1586707199\"\n\"ER\",\"000000RN\",\"ID420973533\",\"SSS\",\"1585853254\",\"INDIVIDUAL\",\"APPROVED\",\"1585882125\",\"1586707199\"\n\"PI\",\"1Y0J8GGB\",\"2001723\",\"COM\",\"1585852854\",\"INDIVIDUAL\",\"APPROVED\",\"1585886197\",\"1586707199\"\n\"HM\",\"1GSBA5PH\",\"ID304917547\",\"BIR\",\"1585853259\",\"INDIVIDUAL\",\"APPROVED\",\"1585890422\",\"1586707199\"\n\"CA\",\"000000ZV\",\"ID599908746\",\"COM\",\"1585853251\",\"INDIVIDUAL\",\"APPROVED\",\"1585892647\",\"1586707199\"\n\"DO\",\"000000P9\",\"ID513234062\",\"NBI\",\"1585853253\",\"INDIVIDUAL\",\"APPROVED\",\"1585896962\",\"1586707199\"\n\"GR\",\"106CNPVC\",\"ID959993678\",\"SNR\",\"1585853347\",\"INDIVIDUAL\",\"APPROVED\",\"1585853348\",\"1586707199\"\n\"DO\",\"1ACM2ZN8\",\"ID46952706\",\"SNR\",\"1585853343\",\"INDIVIDUAL\",\"APPROVED\",\"1585853344\",\"1586707199\"\n\"VE\",\"1D3ZFVMS\",\"ID871786328\",\"SSS\",\"1585853345\",\"INDIVIDUAL\",\"APPROVED\",\"1585853346\",\"1586707199\"\n\"DC\",\"00000036\",\"ID576424351\",\"COM\",\"1585853357\",\"INDIVIDUAL\",\"APPROVED\",\"1585853358\",\"1586707199\"\n\"MT\",\"000000CR\",\"ID77269402\",\"SNR\",\"1585853308\",\"INDIVIDUAL\",\"APPROVED\",\"1585878402\",\"1586707199\"\n\"IP\",\"0TN9EG9Q\",\"ID696916736\",\"COM\",\"1585853362\",\"INDIVIDUAL\",\"APPROVED\",\"1585853363\",\"1586707199\"\n\"FS\",\"0G05WNCP\",\"ID208489359\",\"CML\",\"1585853367\",\"INDIVIDUAL\",\"APPROVED\",\"1585853368\",\"1586707199\"\n\"FS\",\"000000ZV\",\"ID726864407\",\"LTO\",\"1585853369\",\"INDIVIDUAL\",\"APPROVED\",\"1585853370\",\"1586707199\"\n\"AG\",\"000000MD\",\"JDIAZ-AUTO-720\",\"PWD\",\"1585855443\",\"INDIVIDUAL\",\"APPROVED\",\"1585855444\",\"1586707199\"\n\"GR\",\"181ZTW6G\",\"ID559655268\",\"SNR\",\"1585853372\",\"INDIVIDUAL\",\"APPROVED\",\"1585853373\",\"1586707199\"\n\"CA\",\"0HRT6DW9\",\"333\",\"NBI\",\"1585853907\",\"INDIVIDUAL\",\"APPROVED\",\"1585853923\",\"1586707199\"\n\"AG\",\"1C4VDD61\",\"JDIAZ-AUTO-720\",\"PWD\",\"1585855375\",\"INDIVIDUAL\",\"APPROVED\",\"1585855376\",\"1586707199\"\n\"SS\",\"0DJ74JNT\",\"C0272ESA200000\",\"PLT\",\"1585855338\",\"VEHICLE\",\"APPROVED\",\"1585869026\",\"1586707199\"\n\"BA\",\"12YCT1PM\",\"2001723\",\"PLT\",\"1585855411\",\"VEHICLE\",\"APPROVED\",\"1585878797\",\"1586707199\"\n\"BP\",\"000000DT\",\"123\",\"LTO\",\"1585856930\",\"INDIVIDUAL\",\"APPROVED\",\"1585856951\",\"1586707199\"\n\"GR\",\"0000008G\",\"ID916422191\",\"SSS\",\"1585857921\",\"INDIVIDUAL\",\"APPROVED\",\"1585857923\",\"1586707199\"\n\"GR\",\"07NQS1GX\",\"ID91961050\",\"PLT\",\"1585857923\",\"VEHICLE\",\"APPROVED\",\"1585857925\",\"1586707199\"\n\"DO\",\"0000006C\",\"ID665168995\",\"OFW\",\"1585857925\",\"INDIVIDUAL\",\"APPROVED\",\"1585857927\",\"1586707199\"\n\"MF\",\"000000CR\",\"ID374590111\",\"CND\",\"1585857927\",\"VEHICLE\",\"APPROVED\",\"1585857929\",\"1586707199\"\n\"ME\",\"1QCFTSFZ\",\"ID830123307\",\"PHC\",\"1585857929\",\"INDIVIDUAL\",\"APPROVED\",\"1585857931\",\"1586707199\"\n\"HT\",\"1VD6KVD7\",\"ID139328582\",\"PLT\",\"1585857931\",\"VEHICLE\",\"APPROVED\",\"1585857933\",\"1586707199\"\n\"AG\",\"000000P9\",\"ID679952236\",\"CML\",\"1585857951\",\"INDIVIDUAL\",\"APPROVED\",\"1585857952\",\"1586707199\"\n\"SS\",\"18S11W3X\",\"ID657481946\",\"CND\",\"1585857953\",\"VEHICLE\",\"APPROVED\",\"1585857954\",\"1586707199\"\n\"UT\",\"1N4NFRMM\",\"ID823068239\",\"DPL\",\"1585857962\",\"INDIVIDUAL\",\"APPROVED\",\"1585857963\",\"1586707199\"\n\"MF\",\"0J6JHC7M\",\"ID209306498\",\"CND\",\"1585857964\",\"VEHICLE\",\"APPROVED\",\"1585857965\",\"1586707199\"\n\"AG\",\"000000CR\",\"ID148452593\",\"BIR\",\"1585857983\",\"INDIVIDUAL\",\"APPROVED\",\"1585857984\",\"1586707199\"\n\"ER\",\"000000CR\",\"ID546923102\",\"CND\",\"1585857984\",\"VEHICLE\",\"APPROVED\",\"1585857986\",\"1586707199\"\n\"BA\",\"0MTY29MB\",\"ID213784120\",\"SSS\",\"1585857987\",\"INDIVIDUAL\",\"APPROVED\",\"1585857988\",\"1586707199\"\n\"MF\",\"0FSYB543\",\"ID947270275\",\"PLT\",\"1585857988\",\"VEHICLE\",\"APPROVED\",\"1585857990\",\"1586707199\"\n\"GO\",\"000000G5\",\"ID289132862\",\"PWD\",\"1585859343\",\"INDIVIDUAL\",\"APPROVED\",\"1585859345\",\"1586707199\"\n\"ER\",\"0000008G\",\"ID335132036\",\"CML\",\"1585857992\",\"INDIVIDUAL\",\"APPROVED\",\"1585857993\",\"1586707199\"\n\"PH\",\"1TSBMRET\",\"ID713834848\",\"PLT\",\"1585857995\",\"VEHICLE\",\"APPROVED\",\"1585857997\",\"1586707199\"\n\"MF\",\"1PRT5C8Z\",\"ID395896320\",\"CND\",\"1585859345\",\"VEHICLE\",\"APPROVED\",\"1585859347\",\"1586707199\"\n\"IP\",\"0000009J\",\"ID577674479\",\"POS\",\"1585859785\",\"INDIVIDUAL\",\"APPROVED\",\"1585859786\",\"1586707199\"\n\"CA\",\"0CJXZWRD\",\"ID2167722\",\"DPL\",\"1585859824\",\"INDIVIDUAL\",\"APPROVED\",\"1585859867\",\"1586707199\"\n\"SS\",\"000000H7\",\"C0272ESA200000\",\"PLT\",\"1585859664\",\"VEHICLE\",\"APPROVED\",\"1585859851\",\"1586707199\"\n\"GO\",\"18JN0MXC\",\"ID819978495\",\"PWD\",\"1585860696\",\"INDIVIDUAL\",\"APPROVED\",\"1585860697\",\"1586707199\"\n\"DC\",\"0BRGG2ZS\",\"ID754183025\",\"PWD\",\"1585860886\",\"INDIVIDUAL\",\"APPROVED\",\"1585860887\",\"1586707199\"\n\"HT\",\"000000RN\",\"ID916823292\",\"CND\",\"1585860888\",\"VEHICLE\",\"APPROVED\",\"1585860890\",\"1586707199\"\n\"TF\",\"000000G5\",\"ID409500530\",\"OFW\",\"1585861031\",\"INDIVIDUAL\",\"APPROVED\",\"1585861033\",\"1586707199\"\n\"ER\",\"0GQXM1CY\",\"ID885682775\",\"PLT\",\"1585861034\",\"VEHICLE\",\"APPROVED\",\"1585861035\",\"1586707199\"\n\"BP\",\"0000009J\",\"ID781179660\",\"COM\",\"1585861036\",\"INDIVIDUAL\",\"APPROVED\",\"1585861037\",\"1586707199\"\n\"GR\",\"0NANF4FZ\",\"ID558533758\",\"PRC\",\"1585861463\",\"INDIVIDUAL\",\"APPROVED\",\"1585861464\",\"1586707199\"\n\"VE\",\"000000H7\",\"ID701675113\",\"PLT\",\"1585861465\",\"VEHICLE\",\"APPROVED\",\"1585861466\",\"1586707199\"\n\"MT\",\"0PSB6YY0\",\"ID59144467\",\"PGB\",\"1585861467\",\"INDIVIDUAL\",\"APPROVED\",\"1585861468\",\"1585777028\"\n\"DC\",\"000000NF\",\"ID100319702\",\"PLT\",\"1585861469\",\"VEHICLE\",\"APPROVED\",\"1585861470\",\"1586707199\"\n\"SS\",\"03H5RDR1\",\"C0272ESA200001\",\"CML\",\"1585856021\",\"INDIVIDUAL\",\"APPROVED\",\"1585861474\",\"1586707199\"\n\"UT\",\"077KV8Z8\",\"ID724167660\",\"DFA\",\"1585861522\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861523\",\"1586707199\"\n\"MF\",\"1EDSWN07\",\"ID665722105\",\"PLT\",\"1585861532\",\"VEHICLE\",\"SUSPENDED\",\"1585861533\",\"1586707199\"\n\"MF\",\"000000AM\",\"ID652488591\",\"OFW\",\"1585861471\",\"INDIVIDUAL\",\"APPROVED\",\"1585861472\",\"1586707199\"\n\"ME\",\"00000048\",\"ID137910557\",\"CND\",\"1585861473\",\"VEHICLE\",\"APPROVED\",\"1585861474\",\"1586707199\"\n\"FS\",\"16YC31DW\",\"ID556639184\",\"PGB\",\"1585861492\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861493\",\"1586707199\"\n\"PH\",\"000000VK\",\"ID550934959\",\"PLT\",\"1585861494\",\"VEHICLE\",\"APPROVED\",\"1585861495\",\"1586707199\"\n\"TF\",\"1JAEDZY0\",\"ID848624084\",\"POS\",\"1585861503\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861504\",\"1586707199\"\n\"GR\",\"000000G5\",\"ID419047953\",\"CND\",\"1585861506\",\"VEHICLE\",\"SUSPENDED\",\"1585861507\",\"1586707199\"\n\"MS\",\"02H4E11R\",\"ID190275635\",\"CND\",\"1585861525\",\"VEHICLE\",\"SUSPENDED\",\"1585861527\",\"1586707199\"\n\"PI\",\"0VHCARNE\",\"ID740933775\",\"CND\",\"1585861835\",\"VEHICLE\",\"APPROVED\",\"1585861836\",\"1586707199\"\n\"PM\",\"1PFW9X8G\",\"ID366495870\",\"PLT\",\"1585861825\",\"VEHICLE\",\"APPROVED\",\"1585861826\",\"1586707199\"\n\"AG\",\"0000007E\",\"ID485783250\",\"SSS\",\"1585861529\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861530\",\"1586707199\"\n\"GO\",\"0T8AQ7DC\",\"ID402384047\",\"POS\",\"1585861536\",\"INDIVIDUAL\",\"APPROVED\",\"1585861537\",\"1586707199\"\n\"HM\",\"0TWG985W\",\"ID635314142\",\"PLT\",\"1585861539\",\"VEHICLE\",\"APPROVED\",\"1585861540\",\"1586707199\"\n\"SS\",\"000000DT\",\"C0272ESA200001\",\"PLT\",\"1585855541\",\"VEHICLE\",\"APPROVED\",\"1585861585\",\"1586707199\"\n\"DO\",\"000000K3\",\"ID940700275\",\"COM\",\"1585861827\",\"INDIVIDUAL\",\"APPROVED\",\"1585861829\",\"1586707199\"\n\"FC\",\"0000005A\",\"ID708704557\",\"DFA\",\"1585861806\",\"INDIVIDUAL\",\"APPROVED\",\"1585861807\",\"1586707199\"\n\"GO\",\"0000008G\",\"ID43899645\",\"SNR\",\"1585861823\",\"INDIVIDUAL\",\"APPROVED\",\"1585861824\",\"1586707199\"\n\"UT\",\"0SC2DS7Z\",\"ID878109479\",\"CND\",\"1585861830\",\"VEHICLE\",\"APPROVED\",\"1585861831\",\"1586707199\"\n\"MS\",\"000000H7\",\"ID527137490\",\"PRC\",\"1585861832\",\"INDIVIDUAL\",\"APPROVED\",\"1585861834\",\"1586707199\"\n\"GO\",\"000000WX\",\"ID275720364\",\"SNR\",\"1585861856\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861857\",\"1586707199\"\n\"SH\",\"000000CR\",\"ID477289687\",\"CND\",\"1585861858\",\"VEHICLE\",\"APPROVED\",\"1585861860\",\"1586707199\"\n\"MS\",\"000000H7\",\"ID769310183\",\"PRC\",\"1585861868\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861870\",\"1586707199\"\n\"GR\",\"000000K3\",\"ID264717048\",\"PLT\",\"1585861895\",\"VEHICLE\",\"SUSPENDED\",\"1585861897\",\"1586707199\"\n\"DO\",\"000000G5\",\"ID176886182\",\"CND\",\"1585861871\",\"VEHICLE\",\"SUSPENDED\",\"1585861873\",\"1586707199\"\n\"GO\",\"000000XZ\",\"ID340571058\",\"DFA\",\"1585861891\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861893\",\"1586707199\"\n\"VE\",\"0000005A\",\"ID926424268\",\"PWD\",\"1585861899\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585861900\",\"1586707199\"\n\"BP\",\"0QX99GQ3\",\"ID589523526\",\"PLT\",\"1585861902\",\"VEHICLE\",\"SUSPENDED\",\"1585861904\",\"1586707199\"\n\"FS\",\"0000008G\",\"ID309687403\",\"PHC\",\"1585861908\",\"INDIVIDUAL\",\"APPROVED\",\"1585861909\",\"1586707199\"\n\"LW\",\"000000XZ\",\"ID258985131\",\"CND\",\"1585861912\",\"VEHICLE\",\"APPROVED\",\"1585861913\",\"1586707199\"\n\"DO\",\"1ZGEYJFT\",\"ID693915009\",\"OFW\",\"1585863278\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585863280\",\"1586707199\"\n\"TF\",\"0000009J\",\"ID819498748\",\"PGB\",\"1585863287\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585863289\",\"1586707199\"\n\"PH\",\"000000QB\",\"ID639026753\",\"CND\",\"1585863283\",\"VEHICLE\",\"SUSPENDED\",\"1585863284\",\"1586707199\"\n\"UT\",\"000000SQ\",\"ID874357931\",\"CND\",\"1585863291\",\"VEHICLE\",\"SUSPENDED\",\"1585863293\",\"1586707199\"\n\"GO\",\"0VTVNXVN\",\"ID277580936\",\"PRC\",\"1585863298\",\"INDIVIDUAL\",\"APPROVED\",\"1585863300\",\"1586707199\"\n\"TF\",\"000000XZ\",\"ID729120969\",\"PLT\",\"1585863303\",\"VEHICLE\",\"APPROVED\",\"1585863304\",\"1586707199\"\n\"PM\",\"000EXKAT\",\"ID36293086\",\"PRC\",\"1585863370\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585863372\",\"1586707199\"\n\"FS\",\"000000J1\",\"ID908327347\",\"CND\",\"1585863383\",\"VEHICLE\",\"SUSPENDED\",\"1585863385\",\"1586707199\"\n\"HM\",\"00000024\",\"ID444433602\",\"PLT\",\"1585863374\",\"VEHICLE\",\"SUSPENDED\",\"1585863376\",\"1586707199\"\n\"MF\",\"0XYG83N1\",\"ID922853556\",\"PRC\",\"1585863379\",\"INDIVIDUAL\",\"SUSPENDED\",\"1585863381\",\"1586707199\"\n\"PI\",\"000000AM\",\"ID90167142\",\"LTO\",\"1585863390\",\"INDIVIDUAL\",\"APPROVED\",\"1585863391\",\"1586707199\"\n';
      final d = CsvToListConverter(eol: '\n').convert(rawCsv);
      expect(d.length, equals(101));
      print(d);
    });
  });
}
